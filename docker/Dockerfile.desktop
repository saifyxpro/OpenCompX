FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:1
ENV VNC_PORT=5901
ENV NO_VNC_PORT=6080
ENV VNC_RESOLUTION=1920x1080
ENV VNC_COL_DEPTH=24

# Install desktop and VNC
# Install desktop and VNC
RUN apt-get update && apt-get install -y software-properties-common && \
    add-apt-repository ppa:mozillateam/ppa && \
    echo 'Package: *' > /etc/apt/preferences.d/mozilla-firefox && \
    echo 'Pin: release o=LP-PPA-mozillateam' >> /etc/apt/preferences.d/mozilla-firefox && \
    echo 'Pin-Priority: 1001' >> /etc/apt/preferences.d/mozilla-firefox && \
    apt-get update && apt-get install -y \
    xfce4 \
    xfce4-goodies \
    tigervnc-standalone-server \
    tigervnc-common \
    novnc \
    websockify \
    dbus-x11 \
    x11-utils \
    x11-xserver-utils \
    xdotool \
    scrot \
    imagemagick \
    firefox \
    python3 \
    python3-pip \
    curl \
    wget \
    git \
    sudo \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Python packages for automation
RUN pip3 install --no-cache-dir pyautogui pillow opencv-python-headless

# Create user
RUN useradd -m -s /bin/bash agent && \
    echo "agent:agent" | chpasswd && \
    adduser agent sudo

# Setup VNC
RUN mkdir -p /home/agent/.vnc && \
    echo "agent" | vncpasswd -f > /home/agent/.vnc/passwd && \
    chmod 600 /home/agent/.vnc/passwd && \
    chown -R agent:agent /home/agent/.vnc

# VNC startup script
RUN echo '#!/bin/bash\n\
export DISPLAY=:1\n\
export HOME=/home/agent\n\
rm -rf /tmp/.X1-lock /tmp/.X11-unix/X1 2>/dev/null\n\
vncserver :1 -geometry $VNC_RESOLUTION -depth $VNC_COL_DEPTH -localhost no\n\
sleep 5\n\
export DISPLAY=:1\n\
xset s off\n\
xset -dpms\n\
xset s noblank\n\
# Aggressively disable XFCE power management and locking\n\
xfconf-query -c xfce4-power-manager -p /xfce4-power-manager/presentation-mode -s true\n\
xfconf-query -c xfce4-power-manager -p /xfce4-power-manager/blank-on-ac -s 0\n\
xfconf-query -c xfce4-power-manager -p /xfce4-power-manager/dpms-on-ac-sleep -s 0\n\
xfconf-query -c xfce4-power-manager -p /xfce4-power-manager/dpms-on-ac-off -s 0\n\
xfconf-query -c xfce4-power-manager -p /xfce4-power-manager/lock-screen-suspend-hibernate -s false\n\
xfconf-query -c xfce4-session -p /sessions/ScreensaverMode -s 0\n\
xfconf-query -c xfce4-screensaver -p /saver/enabled -s false\n\
xfconf-query -c xfce4-screensaver -p /lock/enabled -s false\n\
# Kill any existing lockers\n\
pkill light-locker || true\n\
pkill xfce4-screensaver || true\n\
websockify --web=/usr/share/novnc/ $NO_VNC_PORT localhost:$VNC_PORT &\n\
tail -f /dev/null\n\
' > /startup.sh && chmod +x /startup.sh

# XFCE config - disable screensaver and auto-lock
RUN mkdir -p /home/agent/.config/xfce4/xfconf/xfce-perchannel-xml && \
    echo '<?xml version="1.0" encoding="UTF-8"?>\n\
<channel name="xfce4-power-manager" version="1.0">\n\
  <property name="xfce4-power-manager" type="empty">\n\
    <property name="dpms-enabled" type="bool" value="false"/>\n\
    <property name="blank-on-ac" type="int" value="0"/>\n\
  </property>\n\
</channel>' > /home/agent/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-power-manager.xml && \
    chown -R agent:agent /home/agent/.config

# Firefox policies (disable first-run)
RUN mkdir -p /usr/lib/firefox/distribution && \
    echo '{"policies":{"OverrideFirstRunPage":"","OverridePostUpdatePage":"","DisableProfileImport":true,"DontCheckDefaultBrowser":true}}' \
    > /usr/lib/firefox/distribution/policies.json

WORKDIR /home/agent
USER agent

EXPOSE 5901 6080

CMD ["/startup.sh"]
